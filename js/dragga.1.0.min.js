/*
 * dragga.js JavaScript Library v1.0
 * Copyright (c) 2016 ymz
 * Released under a Creative Commons Attribution 4.0 International License
 * https://github.com/ymz-rocks/dragga.js/blob/master/LICENSE.md
 */

(function(b){function f(c,i,e){function h(d,b){this.min=d;this.max=b;this.unit=new a;this.value=new a;this.position=new a;this.refresh=function(f){var e=c.position(),b=new a(Math.abs(this.max.x-this.min.x),Math.abs(this.max.y-this.min.y)),i="x",j="y",g=c.parent(),d=new a(g.innerWidth()-c.outerWidth(),g.innerHeight()-c.outerHeight());this.unit.set(d.x/b.x,d.y/b.y);if(f)this.position.set(this.value.x*d.x,this.value.y*d.y).round();else{this.position.set(e.left,e.top);this.value.set(e.left/d.x,e.top/d.y)}if(b.valid(i)){if(!f)this.value.x=Math.max(Math.min(Math.floor(this.value.x*b.x),this.max.x),0)+this.min.x;this.position.x=(this.value.x-this.min.x)*this.unit.x}if(b.valid(j)){if(!f)this.value.y=Math.max(Math.min(Math.floor(this.value.y*b.y),this.max.y),0)+this.min.y;this.position.y=(this.value.y-this.min.y)*this.unit.y}var h=c.hasClass("xy");if(!h&&!c.hasClass(i))this.value.x=undefined;if(!h&&!c.hasClass(j))this.value.y=undefined}}function j(a,b){this.start=a;this.end=b;this.duration=0}function g(){this.from=new a;this.to=new a;this.direction=new a;this.distance=new a;this.velocity=new a}function f(b,a){if(isFinite(a)&&c.filter(":animated").length==0){c.animate(b,a,"swing");return d}c.css(b);return d}var d=this;this.$=c;this.args=i;this.args.e=this;this.adjust=function(h,i){var b=c.position(),g=new a(this.range.position.x,this.range.position.y),d={};if(this.range.value.x){this.travel.to.x=g.x;if(Math.abs(b.left-this.range.position.x)>Math.abs(this.range.position.x+this.range.unit.x-b.left)){this.travel.to.x+=this.range.unit.x;this.range.value.x++}d.left=this.travel.to.x}if(this.range.value.y){this.travel.to.y=g.y;if(Math.abs(b.top-this.range.position.y)>Math.abs(this.range.position.y+this.range.unit.y-b.top)){this.travel.to.y+=this.range.unit.y;this.range.value.y++}d.top=this.travel.to.y}return i||arguments.length==1&&e.bool(arguments[0])&&arguments[0]?f(d,h):this};this.invoke=function(a){b.isFunction(this.args[a])&&this.args[a](this);return this};this.refresh=function(a){this.range.refresh(true);return f({left:this.range.position.x,top:this.range.position.y},a)};this.reset=function(){this.active=false;this.user=false;this.anchor=new a;this.time=new j;this.travel=new g;this.range=new h(new a(this.args.minX,this.args.minY),new a(this.args.maxX,this.args.maxY));return this};this.stop=function(){this.active=false;this.invoke("end")};this.update=function(c,d){this.time.end=e.time();this.time.duration=this.time.end-this.time.start;var b=this.time/1e3;this.travel.direction=new a(this.travel.to.x>this.travel.from.x?1:-1,this.travel.to.y>this.travel.from.y?1:-1),this.travel.direction.x*=c;this.travel.direction.y*=d;this.travel.distance.set(Math.abs(this.travel.to.x-this.travel.from.x),Math.abs(this.travel.to.y-this.travel.from.y));this.travel.velocity.set(this.travel.distance.x/b,this.travel.distance.y/b).round();this.range.refresh();return this};this.reset()}function d(d,a){var c=this;function e(c){var f={};for(var e in c){if(!c[e])continue;d.each(function(){var d=b(this),i=a.e(d);if(!i)return;var g=d.offset(),h=i.args.space;if(c[e].pageX<g.left-h||c[e].pageX>g.left+d.outerWidth()+h)return;if(c[e].pageY<g.top-h||c[e].pageY>g.top+d.outerHeight()+h)return;if(a.time()-i.time.end<i.args.hold)f[d.index()]=c[e]})}return f}this.start=function(d,f,h){var b=a.e(d);if(!b)return this;var g=d.hasClass("xy"),e=d.position(),i=d.hasClass("x")||g?e.left-f.pageX:undefined,j=d.hasClass("y")||g?e.top-f.pageY:undefined;b.reset();b.active=true;b.user=h;b.travel.from.set(e.left,e.top);b.range.position.set(e.left,e.top);b.time.start=a.time();b.anchor.set(i,j);b.invoke("start");b.args.lock&&c.end(d);return this};this.inside=function(c,d,f){var b=a.e(c);if(!b||!b.active&&!f)return this;b.travel.to.set(b.anchor.x+d.pageX,b.anchor.y+d.pageY);var e=c.parent(),g=Math.max(Math.min(e.innerWidth()-c.outerWidth(),b.travel.to.x),0),h=Math.max(Math.min(e.innerHeight()-c.outerHeight(),b.travel.to.y),0);b.travel.to.valid("x")&&c.css("left",g);b.travel.to.valid("y")&&c.css("top",h);b.update(b.anchor.x==-d.pageX?-1:1,b.anchor.y==-d.pageY?-1:1);b.invoke("drag");return this};this.outside=function(f,g){var a=e(f);d.each(function(){var d=b(this),e=d.index();if(a[e])return c.inside(d,a[e],g);c.end(d)});return this};this.end=function(c,d){var b=a.e(c);if(!b)return this;if(b.active||d)b.invoke("end").active=false;return this};this.terminate=function(){var a=arguments.length==0,f=a?null:e(arguments[0]);d.each(function(){var d=b(this);if(a)return c.end(d,true);f[d.index()]&&c.end(d,true)});return this}}function e(){var b="data-dragga-id",a=function(a){return a.originalEvent.targetTouches?true:false};this.active=function(b){return a(b)?true:b.which==1};this.bool=function(a){return typeof a=="boolean"};this.e=function(a){return c[this.id(a)]};this.event=function(b){return a(b)?b.originalEvent.targetTouches[0]:b};this.events=function(b){return a(b)?b.originalEvent.targetTouches:[b]};this.id=function(c,a){if(a){c.attr(b,a);return a}else{a=c.attr(b);return isFinite(a)?a:this.id(c,Math.random()*1e7|0)}};this.reg=function(b,e,a,d){var c=a.split(" ");a="";for(var f in c)a+=c[f]+"."+e+" ";b.off(a,b.selector).on(a,b.selector,d);return this};this.selectable=function(b,c){if(!b||b.length==0)return b;if(c==undefined)c=true;var a=c?"text":"none",d="selectstart";b.attr("unselectable",c?"off":"on").css("user-select",a).css("-webkit-touch-callout",a).css("-webkit-user-select",a).css("-khtml-user-select",a).css("user-select",a).css("-moz-user-select",a).css("-ms-user-select",a);this.reg(b,this.id(b),"selectstart",c)};this.time=function(){return(new Date).getTime()}}function a(b,c){var a;this.x=undefined;this.y=undefined;this.equals=function(a){return(this.x==a.x||this.x==a.left)&&(this.y==a.y||this.y==a.top)};this.round=function(){if(this.x)this.x=Math.round(this.x);if(this.y)this.y=Math.round(this.y);return this};this.set=function(b,c){a={};if(isFinite(b)){this.x=b;a.x=true}if(isFinite(c)){this.y=c;a.y=true}return this};this.valid=function(b){return a[b]};this.set(b,c)}function g(e,d,a){function g(){this.e=undefined;this.hold=300;this.space=200;this.trigger=true;this.lock=false;this.minX=undefined;this.minY=undefined;this.maxX=undefined;this.maxY=undefined;this.start=function(){};this.drag=function(){};this.end=function(){};this.match=function(a){if(!this.e)return;if(!b.isArray(a))a=[a];for(var c in a)if(this.e.$.hasClass(a[c]))return a[c]};this.refresh=function(){if(!isFinite(this.hold))this.hold=300;if(!isFinite(this.space))this.space=200;if(isFinite(this.minX))this.minX|=0;if(isFinite(this.minY))this.minY|=0;if(isFinite(this.maxX))this.maxX|=0;if(isFinite(this.maxY))this.maxY|=0;return this}}this.args=function(a){if(b.isFunction(a)){this.refresh(a);return}return b.extend(new g,a).refresh()};this.drag=function(c,f){function g(c,f){if(c.length==0)return;var g=c[0].tagName.toLowerCase();if(g=="body")c=b(document);a.reg(c,e,"mousemove touchmove",function(b){b.preventDefault();!f&&b.stopPropagation();a.active(b)&&d.outside(a.events(b),f)}).reg(c,e,"mouseleave touchend touchcancel",function(a){a.preventDefault();a.stopPropagation()}).reg(c,e,"mouseup",function(b){b.preventDefault();a.active(b)&&d.terminate()})}var e=a.id(c);a.reg(c,e,"mousedown touchstart",function(b){b.preventDefault();d.start(c,a.event(b),true)}).reg(c,e,"mousemove touchmove",function(b){b.preventDefault();b.stopPropagation();a.active(b)&&d.inside(c,a.event(b))}).reg(c,e,"mouseup touchend touchcancel",function(a){a.preventDefault();d.end(c)});g(f);g(f.parent(),true);return this};this.gesture=function(b,c){var f="xy",e=a.id(b);!b.hasClass(f)&&b.addClass(f);a.reg(c,e,"mousedown touchstart",function(c){c.preventDefault();b.css({left:c.pageX,top:c.pageY});d.start(b,a.event(c),true)}).reg(c,e,"mousemove touchmove",function(c){c.preventDefault();c.stopPropagation();a.active(c)&&d.inside(b,a.event(c))}).reg(c,e,"mouseleave mouseup touchend touchcancel",function(a){a.preventDefault();a.stopPropagation();d.end(b)})};this.refresh=function(f,d){e.each(function(){var e=a.id(b(this));c[e]&&f(c[e]);d&&d(c[e])});return this};this.trigger=function(){e.each(function(){var a=b(this);if(a.hasClass("x")||a.hasClass("y")||a.hasClass("xy")){var c=a.offset(),e={pageX:c.left,pageY:c.top};d.start(a,e).inside(a,e,true).end(a)}});return parent};this.update=function(d,h,i){var e=a.id(d);d.css("position","absolute");a.selectable(d,false);a.selectable(h,false);h.css("position")=="static"&&h.css("position","relative");if(!c[e])c[e]=new f(d,b.extend(new g,i),a);else b.extend(c[e].args,i);c[e].refresh();return this}}var c={};b.fn.dragga=function(h){var f=new e,i=new d(this,f),c=new g(this,i,f),a=c.args(h);if(!a)return;var j=a.trigger;this.each(function(){var d=b(this),e=d.parent(),f=d.hasClass("x")||d.hasClass("y")||d.hasClass("xy")?"drag":"gesture";c.update(d,e,a)[f](d,e)});if(b.isFunction(a.trigger))c.refresh(a.trigger,function(a){a.invoke("start").invoke("drag").invoke("end")});else a.trigger&&c.trigger();return this}})(jQuery)
